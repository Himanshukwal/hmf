

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>hmf &mdash; hmf 1.1.10 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.10',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="hmf 1.1.10 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">hmf 1.1.10 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for hmf</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Perturbations.py contains a single class (Perturbations), which contains</span>
<span class="sd">methods that act upon a transfer function to gain functions such as the</span>
<span class="sd">mass function.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">version</span> <span class="o">=</span> <span class="s">&#39;1.1.10&#39;</span>

<span class="c">###############################################################################</span>
<span class="c"># Some Imports</span>
<span class="c">###############################################################################</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">InterpolatedUnivariateSpline</span> <span class="k">as</span> <span class="n">spline</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="kn">as</span> <span class="nn">intg</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="nb">abs</span><span class="p">,</span> <span class="n">arctan</span><span class="p">,</span> <span class="n">arccos</span><span class="p">,</span> <span class="n">arcsin</span><span class="p">,</span> <span class="n">exp</span>

<span class="c"># from scitools.std import sin,cos,tan,abs,arctan,arccos,arcsin #Must be in this form to work for some reason.</span>
<span class="kn">from</span> <span class="nn">cosmolopy</span> <span class="kn">import</span> <span class="n">distance</span> <span class="k">as</span> <span class="n">cd</span>
<span class="kn">import</span> <span class="nn">cosmography</span>
<span class="kn">from</span> <span class="nn">cosmo</span> <span class="kn">import</span> <span class="n">Cosmology</span>
<span class="kn">import</span> <span class="nn">tools</span>
<span class="kn">from</span> <span class="nn">fitting_functions</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="c">#TODO: possibly implement weighting by survey volume: n(M,z1,z2) = \int n(M,z)*V(z) dz / \int V(z) dz</span>
<span class="c">###############################################################################</span>
<span class="c"># The Class</span>
<span class="c">###############################################################################</span>
<div class="viewcode-block" id="Perturbations"><a class="viewcode-back" href="../api.html#hmf.Perturbations">[docs]</a><span class="k">class</span> <span class="nc">Perturbations</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class which contains the functions necessary to evaluate the HMF and Mass Variance.</span>
<span class="sd">    </span>
<span class="sd">    The purpose and idea behind the class is to be able to calculate many quantities associated</span>
<span class="sd">    with perturbations in the early Universe. The class is initialized to form a cosmology and</span>
<span class="sd">    takes in various options as to how to calculate the various quantities. Most non-initial </span>
<span class="sd">    methods of the class need no further input after the cosmology has been initialized.</span>
<span class="sd">    </span>
<span class="sd">    Contains an update() method which can be passed arguments to update, in the most optimal manner.</span>
<span class="sd">    All output quantities are called as properties of the class, and are calculated at need (but</span>
<span class="sd">    stored after first calculation for quick access).</span>
<span class="sd">    </span>
<span class="sd">    Output Quantities:</span>
<span class="sd">        sigma:         The mass variance of spheres of the given radius/mass. NOTE: not sigma^2</span>
<span class="sd">        lnsigma:       The natural logarithm of the inverse of sigma</span>
<span class="sd">        lnk:           The natural log of the wavenumbers in the power spectrum [h/Mpc]</span>
<span class="sd">        growth:        The growth factor for the given cosmology and redshift</span>
<span class="sd">        power:         The natural log of the normalised power spectrum for the given cosmology (at lnk)</span>
<span class="sd">        n_eff:         Effective spectral index at the radius of a halo</span>
<span class="sd">        M:             The masses at which analysis is performed. (not log) [M_sun/h]</span>
<span class="sd">        fsigma:        The multiplicity function, or fitting function at M</span>
<span class="sd">        dndm:          The comoving number density of halos in mass interval M [h**4/(M_sun * Mpc**3)]</span>
<span class="sd">        dndlnm:        The comoving number density of halos in log mass interval M [h**3/Mpc**3]</span>
<span class="sd">        dndlog10m:     The comoving number density of halo in log10 mass interval M [h**3/Mpc**3]</span>
<span class="sd">        ngtm:          Comoving number density of halos &gt; M [h**3/Mpc**3]</span>
<span class="sd">        nltm:          Comoving number density of halos &lt; M [h**3/Mpc**3]</span>
<span class="sd">        mgtm:          Comoving mass density of halos &gt; M [M_sun h**3/Mpc**3]</span>
<span class="sd">        mltm:          Comoving mass density of halos &lt; M [M_sun h**3/Mpc**3]</span>
<span class="sd">        how_big:       The requisite size of a simulation box, L, to have at least one halo &gt; M [Mpc/h]</span>
<span class="sd">        </span>
<span class="sd">    Input:</span>
<span class="sd">        M:             A vector of floats containing the log10(Solar Masses/h) at which to perform analysis.    </span>
<span class="sd">                       Default: M = np.linspace(10,15,501)</span>
<span class="sd">                       </span>
<span class="sd">        transfer_file: Either a string pointing to a file with a CAMB-produced transfer function,</span>
<span class="sd">                       or None. If None, will use CAMB on the fly to produce the function.</span>
<span class="sd">                       Default is None.</span>
<span class="sd">                       </span>
<span class="sd">        z:             a float giving the redshift of the analysis.</span>
<span class="sd">                       Default z = 0.0</span>
<span class="sd">                   </span>
<span class="sd">        wdm_mass:      a float giving warm dark matter particle size in keV, or None for CDM. </span>
<span class="sd">                       Default is wdm_mass = None</span>
<span class="sd">                                                       </span>
<span class="sd">        k_bounds:      a list/tuple defining two values: the lower and upper limit of k. Used to truncate/extend</span>
<span class="sd">                       the power spectrum. </span>
<span class="sd">                       Default k_bounds = [0.0000001,20000.0]</span>
<span class="sd">                     </span>
<span class="sd">        mf_fit:        A string indicating which fitting function to use for f(sigma)</span>
<span class="sd">                       Default: mf_fit = &#39;ST&#39;</span>
<span class="sd">                       </span>
<span class="sd">                       Options:                               </span>
<span class="sd">                            1. &#39;PS&#39;: Press-Schechter form from 1974</span>
<span class="sd">                            2. &#39;SMT&#39;: Sheth-Mo-Tormen empirical fit from 2001</span>
<span class="sd">                            3. &#39;Jenkins&#39;: Jenkins empirical fit from 2001</span>
<span class="sd">                            4. &#39;Warren&#39;: Warren empirical fit from 2006</span>
<span class="sd">                            5. &#39;Reed03&#39;: Reed empirical from 2003</span>
<span class="sd">                            6. &#39;Reed07&#39;: Reed empirical from 2007</span>
<span class="sd">                            7. &#39;Tinker&#39;: Tinker empirical from 2008</span>
<span class="sd">                            8. &#39;Watson&#39;: Watson empirical 2012</span>
<span class="sd">                            9. &#39;Watson_FoF&#39;: Watson Friend-of-friend fit 2012</span>
<span class="sd">                            10. &#39;Crocce&#39;: Crocce 2010</span>
<span class="sd">                            11. &#39;Courtin&#39;: Courtin 2011</span>
<span class="sd">                            12. &#39;Angulo&#39;: Angulo 2012</span>
<span class="sd">                            13. &#39;Angulo_Bound&#39;: Angulo sub-halo function 2012</span>
<span class="sd">                            14. &quot;Bhattacharya&quot;: Bhattacharya empirical fit 2011</span>
<span class="sd">                            15. &quot;Behroozi&quot;: Behroozi extension to Tinker for high-z 2013</span>
<span class="sd">                            16. &#39;user_model&#39;: A user-input string function</span>
<span class="sd">        </span>
<span class="sd">        delta_wrt:     Defines what the overdensity of a halo is with respect to, can take &#39;mean&#39; or &#39;crit&#39;</span>
<span class="sd">                       Default: &#39;mean&#39; </span>
<span class="sd">                       </span>
<span class="sd">        delta_halo:    The overdensity for the halo definition, with respect to delta_wrt</span>
<span class="sd">                       Default: delta_halo = 200.0</span>
<span class="sd">                       </span>
<span class="sd">        user_fit:      A string defining a mathematical function in terms of &#39;x&#39;, used as the fitting function,</span>
<span class="sd">                       where x is taken as sigma. Will only be applicable if mf_fit == &quot;user_model&quot;.</span>
<span class="sd">                       Default: user_fit = &quot;&quot;</span>
<span class="sd">                       </span>
<span class="sd">        transfer_fit:  A string defining which transfer function fit to use. Current options are &#39;CAMB&#39; and &#39;EH&#39; (Eistenstein-Hu)</span>
<span class="sd">                       Default: transfer_fit = &quot;CAMB&quot;</span>
<span class="sd">                       </span>
<span class="sd">        cut_fit:       Whether to forcibly cut the f(sigma) at bounds given by respective papers.</span>
<span class="sd">                       If False, will use function to calculate all values specified in M (may give ridiculous results)</span>
<span class="sd">                       Default: True</span>
<span class="sd">                       </span>
<span class="sd">                       </span>
<span class="sd">        **kwargs:      There is a placeholder for any additional cosmological parameters, or camb</span>
<span class="sd">                       parameters, that one wishes to include. Parameters that aren&#39;t used won&#39;t</span>
<span class="sd">                       break the program, they will just be ignored. Here follows a list of parameters</span>
<span class="sd">                       that will be used by various parts of the program, and their respective defaults,</span>
<span class="sd">                       note that cosmological parameters follow PLANCK1 results:</span>
<span class="sd">                       </span>
<span class="sd">                       PARAMETERS USED OUTSIDE OF CAMB ONLY:</span>
<span class="sd">                       sigma_8         :: 0.8347</span>
<span class="sd">                       n               :: 0.9619</span>
<span class="sd">                       delta_c         :: 1.686</span>
<span class="sd">                       </span>
<span class="sd">                       PARAMETERS USED IN CAMB AND OUTSIDE:</span>
<span class="sd">                       omegab          :: 0.049</span>
<span class="sd">                       omegac          :: 0.2678</span>
<span class="sd">                       omegav          :: 0.6817</span>
<span class="sd">                       omegak          :: 1 - omegab - omegac - omegav - omegan</span>
<span class="sd">                       </span>
<span class="sd">                       PARAMETERS USED ONLY IN CAMB</span>
<span class="sd">                       H0              :: 67.04</span>
<span class="sd">                       omegan          :: 0.0</span>
<span class="sd">                       TCMB            :: 2.725</span>
<span class="sd">                       yhe             :: 0.24</span>
<span class="sd">                       Num_Nu_massless :: 3.04 </span>
<span class="sd">                       Num_Nu_massive  :: 0</span>
<span class="sd">                       reion__redshift :: 10.3 </span>
<span class="sd">                       reion__optical_depth :: 0.09</span>
<span class="sd">                       reion__fraction :: -1</span>
<span class="sd">                       reion__delta_redshift :: 1.5</span>
<span class="sd">                       Scalar_initial_condition :: 1</span>
<span class="sd">                       scalar_amp      :: 1E-9</span>
<span class="sd">                       scalar_running  :: 0</span>
<span class="sd">                       tensor_index    :: 0</span>
<span class="sd">                       tensor_ratio    :: 1</span>
<span class="sd">                       lAccuracyBoost :: 1</span>
<span class="sd">                       lSampleBoost   :: 1</span>
<span class="sd">                       w_lam          :: -1</span>
<span class="sd">                       cs2_lam        :: 0</span>
<span class="sd">                       AccuracyBoost  :: 1</span>
<span class="sd">                       WantScalars     :: True</span>
<span class="sd">                       WantTensors     :: False</span>
<span class="sd">                       reion__reionization :: True</span>
<span class="sd">                       reion__use_optical_depth :: True</span>
<span class="sd">                       w_perturb      :: False</span>
<span class="sd">                       DoLensing       :: False </span>
<span class="sd">                       ThreadNum       :: 0 </span>
<span class="sd">                       transfer__k_per_logint :: 11</span>
<span class="sd">                       transfer__kmax :: 0.25</span>
<span class="sd">                                </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">501</span><span class="p">),</span>
                 <span class="n">mf_fit</span><span class="o">=</span><span class="s">&quot;ST&quot;</span><span class="p">,</span>
                 <span class="n">transfer_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">wdm_mass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">k_bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0000001</span><span class="p">,</span> <span class="mf">20000.0</span><span class="p">],</span>
                 <span class="n">delta_halo</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">delta_wrt</span><span class="o">=</span><span class="s">&#39;mean&#39;</span><span class="p">,</span> <span class="n">user_fit</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">transfer_fit</span><span class="o">=</span><span class="s">&#39;CAMB&#39;</span><span class="p">,</span>
                 <span class="n">cut_fit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">z2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the cosmology for which to perform the perturbation analysis.      </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#All cosmological parameters that affect the transfer function (CAMB)</span>
        <span class="c">#Extra derivative parameters are omegak, reion__optical_depth or reion__redshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_cosmo</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;w_lam&quot;</span>    <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                               <span class="s">&quot;omegab&quot;</span>   <span class="p">:</span> <span class="mf">0.0455</span><span class="p">,</span>
                               <span class="s">&quot;omegac&quot;</span>   <span class="p">:</span> <span class="mf">0.226</span><span class="p">,</span>
                               <span class="s">&quot;omegav&quot;</span>   <span class="p">:</span> <span class="mf">0.728</span><span class="p">,</span>
                               <span class="s">&quot;omegan&quot;</span>   <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                               <span class="s">&quot;H0&quot;</span>       <span class="p">:</span> <span class="mf">70.4</span><span class="p">,</span>
                               <span class="s">&#39;cs2_lam&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="s">&#39;TCMB&#39;</span>     <span class="p">:</span> <span class="mf">2.725</span><span class="p">,</span>
                               <span class="s">&#39;yhe&#39;</span>      <span class="p">:</span> <span class="mf">0.24</span><span class="p">,</span>
                               <span class="s">&#39;Num_Nu_massless&#39;</span> <span class="p">:</span> <span class="mf">3.04</span><span class="p">,</span>
                               <span class="s">&#39;reion__redshift&#39;</span><span class="p">:</span> <span class="mf">10.3</span><span class="p">,</span>
                               <span class="s">&#39;reion__optical_depth&#39;</span><span class="p">:</span> <span class="mf">0.085</span>
                               <span class="p">}</span>

        <span class="c">#All other cosmological parameters, derivative parameters are mean_dens and omegam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_cosmo</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;sigma_8&quot;</span><span class="p">:</span><span class="mf">0.81</span><span class="p">,</span>
                            <span class="s">&quot;n&quot;</span><span class="p">:</span><span class="mf">0.967</span><span class="p">,</span>
                            <span class="s">&quot;delta_c&quot;</span><span class="p">:</span><span class="mf">1.686</span><span class="p">,</span>
                            <span class="s">&quot;crit_dens&quot;</span><span class="p">:</span><span class="mf">27.755e10</span>
                            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Num_Nu_massive&#39;</span>  <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="s">&#39;reion__fraction&#39;</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="s">&#39;reion__delta_redshift&#39;</span> <span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
                                 <span class="s">&#39;Scalar_initial_condition&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="s">&#39;scalar_amp&#39;</span>      <span class="p">:</span> <span class="mf">1E-9</span><span class="p">,</span>
                                 <span class="s">&#39;scalar_running&#39;</span>  <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="s">&#39;tensor_index&#39;</span>    <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="s">&#39;tensor_ratio&#39;</span>    <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="s">&#39;lAccuracyBoost&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="s">&#39;lSampleBoost&#39;</span>   <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="s">&#39;AccuracyBoost&#39;</span>  <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="s">&#39;WantScalars&#39;</span>     <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                 <span class="s">&#39;WantTensors&#39;</span>     <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                 <span class="s">&#39;reion__reionization&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                 <span class="s">&#39;reion__use_optical_depth&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                 <span class="s">&#39;w_perturb&#39;</span>      <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                 <span class="s">&#39;DoLensing&#39;</span>       <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                 <span class="s">&#39;transfer__k_per_logint&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                                 <span class="s">&#39;transfer__kmax&#39;</span><span class="p">:</span><span class="mf">0.25</span><span class="p">,</span>
                                 <span class="s">&#39;ThreadNum&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>


        <span class="c">#A list of available HMF fitting functions and their identifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mf_fits</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;PS&quot;</span><span class="p">,</span> <span class="s">&quot;ST&quot;</span><span class="p">,</span> <span class="s">&quot;SMT&quot;</span><span class="p">,</span> <span class="s">&quot;Warren&quot;</span><span class="p">,</span> <span class="s">&quot;Jenkins&quot;</span><span class="p">,</span> <span class="s">&quot;Reed03&quot;</span><span class="p">,</span> <span class="s">&quot;Reed07&quot;</span><span class="p">,</span> <span class="s">&quot;Angulo&quot;</span><span class="p">,</span> <span class="s">&quot;Angulo_Bound&quot;</span><span class="p">,</span> <span class="s">&quot;Tinker&quot;</span><span class="p">,</span>
                        <span class="s">&quot;Watson_FoF&quot;</span><span class="p">,</span> <span class="s">&quot;Watson&quot;</span><span class="p">,</span> <span class="s">&quot;Crocce&quot;</span><span class="p">,</span> <span class="s">&quot;Courtin&quot;</span><span class="p">,</span> <span class="s">&quot;Bhattacharya&quot;</span><span class="p">,</span> <span class="s">&quot;Behroozi&quot;</span><span class="p">,</span> <span class="s">&quot;user_model&quot;</span><span class="p">,</span>
                        <span class="s">&quot;Peacock&quot;</span><span class="p">]</span>

        <span class="c">#Set all given parameters -- annoying but has to be done for best updating</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span> <span class="o">=</span> <span class="n">mf_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_bounds</span> <span class="o">=</span> <span class="n">k_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_file</span> <span class="o">=</span> <span class="n">transfer_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wdm_mass</span> <span class="o">=</span> <span class="n">wdm_mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delta_halo_base</span> <span class="o">=</span> <span class="n">delta_halo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_wrt</span> <span class="o">=</span> <span class="n">delta_wrt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_fit</span> <span class="o">=</span> <span class="n">user_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span> <span class="o">=</span> <span class="n">transfer_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut_fit</span> <span class="o">=</span> <span class="n">cut_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">=</span> <span class="n">nz</span>

        <span class="c">#Now update them all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">mf_fit</span><span class="o">=</span><span class="n">mf_fit</span><span class="p">,</span> <span class="n">k_bounds</span><span class="o">=</span><span class="n">k_bounds</span><span class="p">,</span> <span class="n">transfer_file</span><span class="o">=</span><span class="n">transfer_file</span><span class="p">,</span> <span class="n">wdm_mass</span><span class="o">=</span><span class="n">wdm_mass</span><span class="p">,</span>
                     <span class="n">delta_halo</span><span class="o">=</span><span class="n">delta_halo</span><span class="p">,</span> <span class="n">delta_wrt</span><span class="o">=</span><span class="n">delta_wrt</span><span class="p">,</span> <span class="n">user_fit</span><span class="o">=</span><span class="n">user_fit</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
                     <span class="n">transfer_fit</span><span class="o">=</span><span class="n">transfer_fit</span><span class="p">,</span> <span class="n">cut_fit</span><span class="o">=</span><span class="n">cut_fit</span><span class="p">,</span> <span class="n">z2</span><span class="o">=</span><span class="n">z2</span><span class="p">,</span> <span class="n">nz</span><span class="o">=</span><span class="n">nz</span><span class="p">,</span> <span class="o">**</span> <span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Perturbations.update"><a class="viewcode-back" href="../api.html#hmf.Perturbations.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a convenience method to update any variable that is meant to be in the class in an optimal manner</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#First update the basic dictionaries</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_cosmo</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_cosmo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;omegab&#39;</span><span class="p">:</span>
                        <span class="c">#this parameter directly affects more than just TF</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;omegac&#39;</span><span class="p">:</span>
                        <span class="c">#this parameter directly affects more than just TF</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;H0&#39;</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_cosmo</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="n">val</span><span class="p">})</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">camb_params</span>


            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_cosmo</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_cosmo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unnormalized_power</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;sigma_8&#39;</span><span class="p">:</span>

                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;crit_dens&#39;</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span>
                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;delta_c&#39;</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_extra_cosmo</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="n">val</span><span class="p">})</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span>


            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_options</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="n">val</span><span class="p">})</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">camb_params</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;M&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;M&quot;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;M&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;mf_fit&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;mf_fit&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;mf_fit&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;k_bounds&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;k_bounds&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;k_bounds&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">k_bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;k_bounds&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;transfer_file&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_file</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;transfer_file&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;transfer_file&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;z&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;wdm_mass&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdm_mass</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;wdm_mass&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wdm_mass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;wdm_mass&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;delta_halo&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta_halo_base</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_halo&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_delta_halo_base</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_halo&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&#39;delta_wrt&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_wrt</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_wrt&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delta_wrt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_wrt&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;user_fit&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_fit</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;user_fit&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user_fit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;user_fit&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;transfer_fit&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;transfer_fit&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;transfer_fit&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;cut_fit&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_fit</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cut_fit&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cut_fit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cut_fit&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;z2&quot;</span><span class="p">:</span>  <span class="c">#must be set after z for comparison</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;z2&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">z2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;z2&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="s">&quot;nz&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;nz&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;nz&quot;</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: &quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s">&quot; is not a valid parameter for the Perturbations class&quot;</span>

        <span class="c">#Some extra logic for deletes</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;omegab&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s">&#39;omegac&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s">&#39;omegav&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth</span>
        <span class="k">elif</span> <span class="s">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth</span>

</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cosmo_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All the cosmological parameters&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c">#Piece together the cosmo dictionaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transfer_cosmo</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_cosmo</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="c">#Set some derivative parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegab&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegac&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegam&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegav&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegan&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;crit_dens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.7755E11</span>  <span class="c">#* self.__cosmo_params[&quot;H0&quot;] ** 2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;omegam&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;crit_dens&#39;</span><span class="p">]</span>  <span class="c">#FIXME redshift evolution?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_options</span><span class="p">[</span><span class="s">&#39;reion__use_optical_depth&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;reion__redshift&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span><span class="p">[</span><span class="s">&#39;reion__optical_depth&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span>
    <span class="nd">@cosmo_params.deleter</span>
<div class="viewcode-block" id="Perturbations.cosmo_params"><a class="viewcode-back" href="../api.html#hmf.Perturbations.cosmo_params">[docs]</a>    <span class="k">def</span> <span class="nf">cosmo_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cosmo_params</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">camb_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Every parameter that is passed to camb&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c">#Piece together the cosmo dictionaries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transfer_cosmo</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_options</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="c">#Set some derivative parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;omegak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;omegab&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;omegac&#39;</span><span class="p">]</span> <span class="o">-</span> \
             <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;omegav&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;omegan&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;reion__use_optical_depth&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;reion__redshift&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;reion__optical_depth&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;transfer__kmax&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: transfer__kmax may be too low for accuracy&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;transfer__k_per_logint&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">11</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span><span class="p">[</span><span class="s">&#39;transfer__k_per_logint&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: transfer__k_per_logint may be too low for accuracy&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span>

    <span class="nd">@camb_params.deleter</span>
<div class="viewcode-block" id="Perturbations.camb_params"><a class="viewcode-back" href="../api.html#hmf.Perturbations.camb_params">[docs]</a>    <span class="k">def</span> <span class="nf">camb_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__camb_params</span>

            <span class="c">#We also delete stuff that DIRECTLY depends on it</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnk_original</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mass in units of M_sun/h</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__M</span>

    <span class="nd">@M.setter</span>
<div class="viewcode-block" id="Perturbations.M"><a class="viewcode-back" href="../api.html#hmf.Perturbations.M">[docs]</a>    <span class="k">def</span> <span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;M must be a sequence of length &gt; 1&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;M must be a sequence of length &gt; 1&quot;</span><span class="p">)</span>

        <span class="c">#Delete stuff dependent on it</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlog10m</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__M</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mf_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The mass function fitting function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mf_fit</span>

    <span class="nd">@mf_fit.setter</span>
<div class="viewcode-block" id="Perturbations.mf_fit"><a class="viewcode-back" href="../api.html#hmf.Perturbations.mf_fit">[docs]</a>    <span class="k">def</span> <span class="nf">mf_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;mf_fit must be a string, got &quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf_fits</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;mf_fit is not in the list of available fitting functions: &quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c">#Also delete stuff dependent on it</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__mf_fit</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">k_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The fourier-space limits of the transfer function in wavenumber k</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__k_bounds</span>

    <span class="nd">@k_bounds.setter</span>
<div class="viewcode-block" id="Perturbations.k_bounds"><a class="viewcode-back" href="../api.html#hmf.Perturbations.k_bounds">[docs]</a>    <span class="k">def</span> <span class="nf">k_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;k_bounds must be a sequence of length 2 (lower, upper)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;k_bounds must be a sequence of length 2 (lower, upper)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;k_bounds must be in the form (lower, upper)&quot;</span><span class="p">)</span>

        <span class="c">#We delete stuff directly dependent on it</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnk</span>
        <span class="c">#Wrap the following in a try: except: because self.transfer_fit may not be set yet (at instantiation)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span> <span class="o">==</span> <span class="s">&quot;EH&quot;</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">__k_bounds</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wdm_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The WDM particle mass for a single-species model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__wdm_mass</span>

    <span class="nd">@wdm_mass.setter</span>
<div class="viewcode-block" id="Perturbations.wdm_mass"><a class="viewcode-back" href="../api.html#hmf.Perturbations.wdm_mass">[docs]</a>    <span class="k">def</span> <span class="nf">wdm_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__wdm_mass</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;wdm_mass must be a number (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;wdm_mass must be &gt; 0 (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>

        <span class="c">#Also delete stuff dependent on it</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__wdm_mass</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_delta_halo_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The overdensity given by user: undefined until it is given with respect to something</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delta_halo_base</span>

    <span class="nd">@_delta_halo_base.setter</span>
    <span class="k">def</span> <span class="nf">_delta_halo_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;delta_halo must be a number: &quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;delta_halo must be &gt; 0 (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;delta_halo must be &lt; 10,000 (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>

        <span class="c">#Set the value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__delta_halo_base</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c">#Delete stuff dependent on it</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_halo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta_wrt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines what the delta_halo is with respect to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delta_wrt</span>

    <span class="nd">@delta_wrt.setter</span>
<div class="viewcode-block" id="Perturbations.delta_wrt"><a class="viewcode-back" href="../api.html#hmf.Perturbations.delta_wrt">[docs]</a>    <span class="k">def</span> <span class="nf">delta_wrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;mean&#39;</span><span class="p">,</span> <span class="s">&#39;crit&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;delta_wrt must be either &#39;mean&#39; or &#39;crit&#39; (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__delta_wrt</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_halo</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The redshift</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__z</span>

    <span class="nd">@z.setter</span>
<div class="viewcode-block" id="Perturbations.z"><a class="viewcode-back" href="../api.html#hmf.Perturbations.z">[docs]</a>    <span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;z must be a number (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;z must be &gt; 0 (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>

        <span class="c">#Delete stuff dependent on it</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__z</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Upper redshift for survey volume weighting &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__z2</span>

    <span class="nd">@z2.setter</span>
<div class="viewcode-block" id="Perturbations.z2"><a class="viewcode-back" href="../api.html#hmf.Perturbations.z2">[docs]</a>    <span class="k">def</span> <span class="nf">z2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__z2</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;z must be a number (&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;z2 must be larger than z&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__z2</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Number of redshift bins (if using survey volume weighting) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nz</span>

    <span class="nd">@nz.setter</span>
<div class="viewcode-block" id="Perturbations.nz"><a class="viewcode-back" href="../api.html#hmf.Perturbations.nz">[docs]</a>    <span class="k">def</span> <span class="nf">nz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__nz</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;nz must be an integer&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;nz must be &gt;= 1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__nz</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_transfer_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The path to the file where the transfer function is.</span>
<span class="sd">        If None, triggers on-the-fly calculation by CAMB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_file</span>

    <span class="nd">@_transfer_file.setter</span>
    <span class="k">def</span> <span class="nf">_transfer_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_file</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;The file &quot;</span> <span class="o">+</span> <span class="n">val</span> <span class="o">+</span> <span class="s">&quot; does not exist or cannot be opened&quot;</span><span class="p">)</span>

        <span class="c">#Here we delete properties that are directly dependent on transfer_file</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_file</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A string specifying a mathematical function in terms of x, counted as the mass variance, which defines a fitting function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__user_fit</span>

    <span class="nd">@user_fit.setter</span>
<div class="viewcode-block" id="Perturbations.user_fit"><a class="viewcode-back" href="../api.html#hmf.Perturbations.user_fit">[docs]</a>    <span class="k">def</span> <span class="nf">user_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__user_fit</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transfer_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A string specifying a method with which to calculate the transfer function.</span>
<span class="sd">        </span>
<span class="sd">        Currenty implemented are &#39;CAMB&#39; (Code for anisotropies in the Microwave Background) and &#39;EH&#39; (Eisenstein-Hu fit)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_fit</span>

    <span class="nd">@transfer_fit.setter</span>
<div class="viewcode-block" id="Perturbations.transfer_fit"><a class="viewcode-back" href="../api.html#hmf.Perturbations.transfer_fit">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;CAMB&quot;</span><span class="p">,</span> <span class="s">&quot;EH&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Sorry the transfer_fit has not been implemented for &quot;</span> <span class="o">+</span> <span class="n">val</span> <span class="o">+</span> <span class="s">&quot;. Please choose &#39;CAMB&#39; or &#39;EH&#39;&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_fit</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cut_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cut_fit</span>

    <span class="nd">@cut_fit.setter</span>
<div class="viewcode-block" id="Perturbations.cut_fit"><a class="viewcode-back" href="../api.html#hmf.Perturbations.cut_fit">[docs]</a>    <span class="k">def</span> <span class="nf">cut_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cut_fit must be a bool, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cut_fit</span> <span class="o">=</span> <span class="n">val</span>



    <span class="c">#--------------------------------  START NON-SET PROPERTIES ----------------------------------------------</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta_halo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overdensity of a halo wrt mean density&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delta_halo</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_wrt</span> <span class="o">==</span> <span class="s">&#39;mean&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__delta_halo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta_halo_base</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_wrt</span> <span class="o">==</span> <span class="s">&#39;crit&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__delta_halo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta_halo_base</span> <span class="o">/</span> <span class="n">cosmography</span><span class="o">.</span><span class="n">omegam_z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegam&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegav&#39;</span><span class="p">],</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegak&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delta_halo</span>
    <span class="nd">@delta_halo.deleter</span>
<div class="viewcode-block" id="Perturbations.delta_halo"><a class="viewcode-back" href="../api.html#hmf.Perturbations.delta_halo">[docs]</a>    <span class="k">def</span> <span class="nf">delta_halo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delta_halo</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Perturbations.dlogM"><a class="viewcode-back" href="../api.html#hmf.Perturbations.dlogM">[docs]</a>    <span class="k">def</span> <span class="nf">dlogM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_transfer_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Original values of lnk from the call to the transfer function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_original</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_original</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transfer_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camb_params</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_bounds</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_original</span>

    <span class="nd">@_transfer_original.deleter</span>
    <span class="k">def</span> <span class="nf">_transfer_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_original</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_function_callable</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_transfer_function_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a callable function which is the interpolation of the transfer function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_function_callable</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_function_callable</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">interpolate_transfer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_function_callable</span>

    <span class="nd">@_transfer_function_callable.deleter</span>
    <span class="k">def</span> <span class="nf">_transfer_function_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transfer_function_callable</span>

            <span class="c">#Also delete things directly dependent on it (or other self variables defined in it)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnk</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lnkh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The logarithmic bins in k-space - this is k/h (ie h/Mpc)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnkh</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span> <span class="o">==</span> <span class="s">&quot;CAMB&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lnkh</span><span class="p">,</span> <span class="n">dlnk</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">new_k_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_bounds</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span> <span class="o">==</span> <span class="s">&quot;EH&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lnkh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c"># CHECK KR_BOUNDS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_error</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">check_kr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">],</span>
                                                            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lnkh</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lnkh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_error</span><span class="p">:</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_error</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_error</span><span class="p">:</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_error</span>


            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnkh</span>

    <span class="nd">@lnkh.deleter</span>
<div class="viewcode-block" id="Perturbations.lnkh"><a class="viewcode-back" href="../api.html#hmf.Perturbations.lnkh">[docs]</a>    <span class="k">def</span> <span class="nf">lnkh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnkh</span>

            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unnormalized_power</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnk</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lnk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Logarithmic k-bins. This is NOT k/h, just k (ie. 1/Mpc)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnk</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__lnk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;H0&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnk</span>

    <span class="nd">@lnk.deleter</span>
<div class="viewcode-block" id="Perturbations.lnk"><a class="viewcode-back" href="../api.html#hmf.Perturbations.lnk">[docs]</a>    <span class="k">def</span> <span class="nf">lnk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnk</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_unnormalized_power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The unnormalized power spectrum at z=0 for CDM</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unnormalized_power</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_fit</span> <span class="o">==</span> <span class="s">&quot;CAMB&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__unnormalized_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_function_callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__unnormalized_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_original</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unnormalized_power</span>
    <span class="nd">@_unnormalized_power.deleter</span>
    <span class="k">def</span> <span class="nf">_unnormalized_power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unnormalized_power</span>

            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_power_cdm_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The power spectrum at z=0 for CDM (normalised)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_cdm_0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__power_cdm_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalization</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;sigma_8&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unnormalized_power</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_cdm_0</span>

    <span class="nd">@_power_cdm_0.deleter</span>
    <span class="k">def</span> <span class="nf">_power_cdm_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_cdm_0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_power_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The CDM/WDM power spectrum at z=0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdm_mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Doing wdm with mass = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdm_mass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__power_0</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">wdm_transfer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wdm_mass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&quot;H0&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegac&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__power_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_cdm_0</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_0</span>

    <span class="nd">@_power_0.deleter</span>
    <span class="k">def</span> <span class="nf">_power_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power_0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">power</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_sigma_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The mass variance at z=0, sigma (NOTE: not sigma^2)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sigma_0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sigma_0</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">mass_variance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sigma_0</span>

    <span class="nd">@_sigma_0.deleter</span>
    <span class="k">def</span> <span class="nf">_sigma_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sigma_0</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_dlnsdlnm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The derivative of the natural log of sigma with respect to the natural log of mass (absolute value)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dlnsdlnm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dlnsdlnm</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">dlnsdlnm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dlnsdlnm</span>

    <span class="nd">@_dlnsdlnm.deleter</span>
    <span class="k">def</span> <span class="nf">_dlnsdlnm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dlnsdlnm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">growth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The growth factor d(z)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__growth</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__growth</span> <span class="o">=</span> <span class="n">cosmography</span><span class="o">.</span><span class="n">growth_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegam&#39;</span><span class="p">],</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegak&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegav&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__growth</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__growth</span>

    <span class="nd">@growth.deleter</span>
<div class="viewcode-block" id="Perturbations.growth"><a class="viewcode-back" href="../api.html#hmf.Perturbations.growth">[docs]</a>    <span class="k">def</span> <span class="nf">growth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__growth</span>

            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">power</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The fully realised power spectrum (with all parameters applied)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__power</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">growth</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power</span>
    <span class="nd">@power.deleter</span>
<div class="viewcode-block" id="Perturbations.power"><a class="viewcode-back" href="../api.html#hmf.Perturbations.power">[docs]</a>    <span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__power</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The mass variance at arbitrary redshift (specified in instantiated object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigma_0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sigma</span>

    <span class="nd">@sigma.deleter</span>
<div class="viewcode-block" id="Perturbations.sigma"><a class="viewcode-back" href="../api.html#hmf.Perturbations.sigma">[docs]</a>    <span class="k">def</span> <span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sigma</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnsigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lnsigma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Natural log of inverse mass variance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnsigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__lnsigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnsigma</span>

    <span class="nd">@lnsigma.deleter</span>
<div class="viewcode-block" id="Perturbations.lnsigma"><a class="viewcode-back" href="../api.html#hmf.Perturbations.lnsigma">[docs]</a>    <span class="k">def</span> <span class="nf">lnsigma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lnsigma</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Effective spectral index at scale of halo radius</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__n_eff</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__n_eff</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">n_eff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__n_eff</span>

    <span class="nd">@n_eff.deleter</span>
<div class="viewcode-block" id="Perturbations.n_eff"><a class="viewcode-back" href="../api.html#hmf.Perturbations.n_eff">[docs]</a>    <span class="k">def</span> <span class="nf">n_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__n_eff</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fsigma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The multiplicity function f(sigma) for the fitting function specified as mf_fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fits_class</span> <span class="o">=</span> <span class="n">fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_eff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;delta_c&#39;</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_fit</span><span class="p">)</span>
            <span class="n">nufnu</span> <span class="o">=</span> <span class="n">fits_class</span><span class="o">.</span><span class="n">nufnu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span> <span class="o">=</span> <span class="n">nufnu</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;lots of nans here&quot;</span>
                <span class="c">#the input mass range is almost completely outside the cut</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">massrange_error</span> <span class="o">=</span> <span class="s">&quot;The specified mass-range was almost entirely outside of the limits from the fit. Ignored fit range...&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cut_fit</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">fits_class</span><span class="o">.</span><span class="n">cut_fit</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">nufnu</span> <span class="o">=</span> <span class="n">fits_class</span><span class="o">.</span><span class="n">nufnu</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span> <span class="o">=</span> <span class="n">nufnu</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&quot;now: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span>
    <span class="nd">@fsigma.deleter</span>
<div class="viewcode-block" id="Perturbations.fsigma"><a class="viewcode-back" href="../api.html#hmf.Perturbations.fsigma">[docs]</a>    <span class="k">def</span> <span class="nf">fsigma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fsigma</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dndm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The derivative of the number density of haloes with respect to mass for the range of masses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c">##This is normally the case</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dndm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span> <span class="o">==</span> <span class="s">&#39;Behroozi&#39;</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.144</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">14.79</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.213</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">11.5</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">6.5</span> <span class="o">*</span> <span class="n">a</span><span class="p">)))</span>
                    <span class="n">ngtm_tinker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngtm</span><span class="p">()</span>
                    <span class="n">ngtm_behroozi</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ngtm_tinker</span><span class="p">))</span>
                    <span class="n">dthetadM</span> <span class="o">=</span> <span class="mf">0.144</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">14.79</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.213</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">6.5</span> <span class="o">*</span> <span class="n">a</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">11.5</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">6.5</span> <span class="o">*</span> <span class="n">a</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mf">11.5</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__dndm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndm</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">theta</span> <span class="o">-</span> <span class="n">ngtm_behroozi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">dthetadM</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c">##This is for a survey-volume weighted calculation</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">zedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">)</span>
                <span class="n">zcentres</span> <span class="o">=</span> <span class="p">(</span><span class="n">zedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">zedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">dndm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">zcentres</span><span class="p">)</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">zedges</span><span class="p">)</span>
                <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">comoving_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                                            <span class="n">h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;H0&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                                            <span class="n">omega_M_0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&quot;omegam&quot;</span><span class="p">],</span>
                                            <span class="n">omega_b_0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&quot;omegab&quot;</span><span class="p">],</span>
                                            <span class="n">omega_lambda_0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegav&#39;</span><span class="p">],</span>
                                            <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">zz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zcentres</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">zz</span><span class="p">)</span>
                    <span class="n">dndm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlnsdlnm</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span> <span class="o">==</span> <span class="s">&#39;Behroozi&#39;</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
                        <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.144</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">14.79</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.213</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">11.5</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">6.5</span> <span class="o">*</span> <span class="n">a</span><span class="p">)))</span>
                        <span class="n">ngtm_tinker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngtm</span><span class="p">()</span>
                        <span class="n">ngtm_behroozi</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ngtm_tinker</span><span class="p">))</span>
                        <span class="n">dthetadM</span> <span class="o">=</span> <span class="mf">0.144</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">14.79</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mf">0.213</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">6.5</span> <span class="o">*</span> <span class="n">a</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">**</span> <span class="mf">11.5</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">6.5</span> <span class="o">*</span> <span class="n">a</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mf">11.5</span><span class="p">)</span>
                        <span class="n">dndm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dndm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">theta</span> <span class="o">-</span> <span class="n">ngtm_behroozi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">dthetadM</span>

                    <span class="n">vol</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">comoving_volume</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">zedges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;H0&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                                                <span class="n">omega_M_0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&quot;omegam&quot;</span><span class="p">],</span>
                                                <span class="n">omega_b_0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&quot;omegab&quot;</span><span class="p">],</span>
                                                <span class="n">omega_lambda_0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;omegav&#39;</span><span class="p">],</span>
                                                <span class="p">)</span>

                <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">vol</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c">#Volume in shells</span>
                <span class="n">integrand</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">*</span> <span class="n">dndm</span>
                <span class="n">numerator</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">zcentres</span><span class="p">)</span>
                <span class="n">denom</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">zcentres</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__dndm</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denom</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndm</span>

    <span class="nd">@dndm.deleter</span>
<div class="viewcode-block" id="Perturbations.dndm"><a class="viewcode-back" href="../api.html#hmf.Perturbations.dndm">[docs]</a>    <span class="k">def</span> <span class="nf">dndm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlog10m</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dndlnm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The differential mass function in terms of natural log of M</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndlnm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dndlnm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndlnm</span>

    <span class="nd">@dndlnm.deleter</span>
<div class="viewcode-block" id="Perturbations.dndlnm"><a class="viewcode-back" href="../api.html#hmf.Perturbations.dndlnm">[docs]</a>    <span class="k">def</span> <span class="nf">dndlnm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndlnm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngtm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">nltm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">mgtm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">mltm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">how_big</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dndlog10m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The differential mass function in terms of natural log of M</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndlog10m</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dndlog10m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndlog10m</span>

    <span class="nd">@dndlog10m.deleter</span>
<div class="viewcode-block" id="Perturbations.dndlog10m"><a class="viewcode-back" href="../api.html#hmf.Perturbations.dndlog10m">[docs]</a>    <span class="k">def</span> <span class="nf">dndlog10m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dndlog10m</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">_upper_ngtm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">mass_function</span><span class="p">,</span> <span class="n">cut</span><span class="p">):</span>
        <span class="c">### WE CALCULATE THE MASS FUNCTION ABOVE THE COMPUTED RANGE ###</span>
        <span class="c"># mass_function is logged already (not log10 though)</span>
        <span class="n">m_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">18</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>  <span class="c">#since its been cut, the best we can do is a power law</span>
            <span class="n">mf_func</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">mass_function</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mf_func</span><span class="p">(</span><span class="n">m_upper</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#We try to calculate the hmf as far as we can normally</span>
            <span class="n">sigma_0</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">mass_variance</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_upper</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">])</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth</span>
            <span class="n">dlnsdlnm</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">dlnsdlnm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_upper</span><span class="p">),</span> <span class="n">sigma_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">])</span>
            <span class="n">n_eff</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">n_eff</span><span class="p">(</span><span class="n">dlnsdlnm</span><span class="p">)</span>
            <span class="n">fsigma</span> <span class="o">=</span> <span class="n">fits</span><span class="p">(</span><span class="n">m_upper</span><span class="p">,</span> <span class="n">n_eff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;delta_c&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_fit</span><span class="p">,</span> <span class="n">cut_fit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">nufnu</span><span class="p">()()</span>
            <span class="c">#fsigma = nufnu()</span>
            <span class="n">dndm</span> <span class="o">=</span> <span class="n">fsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dlnsdlnm</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_upper</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_upper</span><span class="p">)</span> <span class="o">*</span> <span class="n">dndm</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c">#Then we couldn&#39;t get up all the way, so have to do linear ext.</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c">#Then the whole extension is nan and we have to use the original (start at 1 because 1 val won&#39;t work either)</span>
                    <span class="n">mf_func</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">mass_function</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">mf</span> <span class="o">=</span> <span class="n">mf_func</span><span class="p">(</span><span class="n">m_upper</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mfslice</span> <span class="o">=</span> <span class="n">mf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">))]</span>
                    <span class="n">m_nan</span> <span class="o">=</span> <span class="n">m_upper</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span>
                    <span class="n">m_true</span> <span class="o">=</span> <span class="n">m_upper</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">))]</span>
                    <span class="n">mf_func</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">m_true</span><span class="p">,</span> <span class="n">mfslice</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">mf</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">mfslice</span><span class="p">):]</span> <span class="o">=</span> <span class="n">mf_func</span><span class="p">(</span><span class="n">m_nan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m_upper</span><span class="p">,</span> <span class="n">mf</span>

    <span class="k">def</span> <span class="nf">_lower_ngtm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">mass_function</span><span class="p">,</span> <span class="n">cut</span><span class="p">):</span>
        <span class="c">### WE CALCULATE THE MASS FUNCTION BELOW THE COMPUTED RANGE ###</span>
        <span class="c"># mass_function is logged already (not log10 though)</span>
        <span class="n">m_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">500</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>  <span class="c">#since its been cut, the best we can do is a power law</span>
            <span class="n">mf_func</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">mass_function</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">mf_func</span><span class="p">(</span><span class="n">m_lower</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#We try to calculate the hmf as far as we can normally</span>
            <span class="n">sigma_0</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">mass_variance</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_lower</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">])</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth</span>
            <span class="n">dlnsdlnm</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">dlnsdlnm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_lower</span><span class="p">),</span> <span class="n">sigma_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_power_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lnkh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">])</span>
            <span class="n">n_eff</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">n_eff</span><span class="p">(</span><span class="n">dlnsdlnm</span><span class="p">)</span>
            <span class="n">fsigma</span> <span class="o">=</span> <span class="n">fits</span><span class="p">(</span><span class="n">m_lower</span><span class="p">,</span> <span class="n">n_eff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf_fit</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;delta_c&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_halo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_fit</span><span class="p">,</span> <span class="n">cut_fit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">nufnu</span><span class="p">()()</span>
            <span class="c">#fsigma = nufnu()</span>
            <span class="n">dndm</span> <span class="o">=</span> <span class="n">fsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmo_params</span><span class="p">[</span><span class="s">&#39;mean_dens&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dlnsdlnm</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_lower</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_lower</span><span class="p">)</span> <span class="o">*</span> <span class="n">dndm</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c">#Then we couldn&#39;t go down all the way, so have to do linear ext.</span>
                <span class="n">mfslice</span> <span class="o">=</span> <span class="n">mf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">))]</span>
                <span class="n">m_nan</span> <span class="o">=</span> <span class="n">m_lower</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">)]</span>
                <span class="n">m_true</span> <span class="o">=</span> <span class="n">m_lower</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mf</span><span class="p">))]</span>
                <span class="n">mf_func</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">m_true</span><span class="p">,</span> <span class="n">mfslice</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mf</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">mfslice</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mf_func</span><span class="p">(</span><span class="n">m_nan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m_lower</span><span class="p">,</span> <span class="n">mf</span>

    <span class="k">def</span> <span class="nf">_ngtm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is separated from the property because of the Behroozi fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># set M and mass_function within computed range</span>
        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>
        <span class="n">mass_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>

        <span class="c">#Calculate the mass function (and its integral) from the highest M up to 10**18</span>
        <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">18</span><span class="p">:</span>
            <span class="n">m_upper</span><span class="p">,</span> <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upper_ngtm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass_function</span><span class="p">),</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">int_upper</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mf</span><span class="p">),</span> <span class="n">dx</span><span class="o">=</span><span class="n">m_upper</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_upper</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">even</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">int_upper</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c">#Calculate the cumulative integral (backwards) of mass_function (Adding on the upper integral)</span>
        <span class="n">ngtm</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">cumtrapz</span><span class="p">(</span><span class="n">mass_function</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">int_upper</span>

        <span class="c">#We need to set ngtm back in the original length vector with nans where they were originally</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ngtm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
            <span class="n">ngtm_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">)</span>
            <span class="n">ngtm_temp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">ngtm_temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span> <span class="o">=</span> <span class="n">ngtm</span>
            <span class="n">ngtm</span> <span class="o">=</span> <span class="n">ngtm_temp</span>

        <span class="k">return</span> <span class="n">ngtm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ngtm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrates the mass function above a certain mass to calculate the number of haloes above a certain mass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ngtm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ngtm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ngtm</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ngtm</span>

    <span class="nd">@ngtm.deleter</span>
<div class="viewcode-block" id="Perturbations.ngtm"><a class="viewcode-back" href="../api.html#hmf.Perturbations.ngtm">[docs]</a>    <span class="k">def</span> <span class="nf">ngtm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ngtm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">how_big</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mgtm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrates the mass function above a certain mass to calculate the mass in haloes above a certain mass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mgtm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>
            <span class="n">mass_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>

            <span class="c">#Calculate the mass function (and its integral) from the highest M up to 10**18</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">18</span><span class="p">:</span>
                <span class="n">m_upper</span><span class="p">,</span> <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upper_ngtm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass_function</span><span class="p">),</span> <span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">int_upper</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mf</span> <span class="o">+</span> <span class="n">m_upper</span><span class="p">)</span> <span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">m_upper</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_upper</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">even</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">int_upper</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c">#Calculate the cumulative integral (backwards) of mass_function (Adding on the upper integral)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mgtm</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">cumtrapz</span><span class="p">(</span><span class="n">mass_function</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">int_upper</span>

            <span class="c">#We need to set ngtm back in the original length vector with nans where they were originally</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mgtm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="n">mgtm_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">)</span>
                <span class="n">mgtm_temp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">mgtm_temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mgtm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__mgtm</span> <span class="o">=</span> <span class="n">mgtm_temp</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mgtm</span>
    <span class="nd">@mgtm.deleter</span>
<div class="viewcode-block" id="Perturbations.mgtm"><a class="viewcode-back" href="../api.html#hmf.Perturbations.mgtm">[docs]</a>    <span class="k">def</span> <span class="nf">mgtm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mgtm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nltm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrates the mass function below a certain mass to calculate the number of haloes below that mass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nltm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># set M and mass_function within computed range</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>
            <span class="n">mass_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>

            <span class="c">#Calculate the mass function (and its integral) from 10**3 up to lowest M</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">m_lower</span><span class="p">,</span> <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lower_ngtm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass_function</span><span class="p">),</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">int_lower</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mf</span><span class="p">),</span> <span class="n">dx</span><span class="o">=</span><span class="n">m_lower</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_lower</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">even</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">int_lower</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">print</span> <span class="s">&quot;INT LOWER = &quot;</span><span class="p">,</span> <span class="n">int_lower</span>
            <span class="c">#Calculate the cumulative integral of mass_function (Adding on the lower integral)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__nltm</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">cumtrapz</span><span class="p">(</span><span class="n">mass_function</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">int_lower</span>

            <span class="c">#We need to set ngtm back in the original length vector with nans where they were originally</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nltm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="n">nltm_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">)</span>
                <span class="n">nltm_temp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">nltm_temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nltm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__nltm</span> <span class="o">=</span> <span class="n">nltm_temp</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nltm</span>
    <span class="nd">@nltm.deleter</span>
<div class="viewcode-block" id="Perturbations.nltm"><a class="viewcode-back" href="../api.html#hmf.Perturbations.nltm">[docs]</a>    <span class="k">def</span> <span class="nf">nltm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nltm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Perturbations.mltm"><a class="viewcode-back" href="../api.html#hmf.Perturbations.mltm">[docs]</a>    <span class="k">def</span> <span class="nf">mltm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrates the mass function above a certain mass to calculate the mass in haloes below a certain mass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mltm</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># Set M within calculated range</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>
            <span class="n">mass_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span>

            <span class="c">#Calculate the mass function (and its integral) from 10**3 up to lowest M</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">m_lower</span><span class="p">,</span> <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lower_ngtm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass_function</span><span class="p">),</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">int_lower</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mf</span> <span class="o">+</span> <span class="n">m_lower</span><span class="p">),</span> <span class="n">dx</span><span class="o">=</span><span class="n">m_lower</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">m_lower</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">even</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">int_lower</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c">#Calculate the cumulative integral of mass_function (Adding on the upper integral)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mltm</span> <span class="o">=</span> <span class="n">intg</span><span class="o">.</span><span class="n">cumtrapz</span><span class="p">(</span><span class="n">mass_function</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">int_lower</span>

            <span class="c">#We need to set ngtm back in the original length vector with nans where they were originally</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mltm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="n">nltm_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">)</span>
                <span class="n">nltm_temp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">nltm_temp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">))]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mltm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__mltm</span> <span class="o">=</span> <span class="n">nltm_temp</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mltm</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">how_big</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculates how big a box must be to expect one halo in natural log mass interval M, for given mass function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngtm</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span>

    <span class="nd">@how_big.deleter</span>
<div class="viewcode-block" id="Perturbations.how_big"><a class="viewcode-back" href="../api.html#hmf.Perturbations.how_big">[docs]</a>    <span class="k">def</span> <span class="nf">how_big</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">how_big</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">hmf 1.1.10 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Steven Murray.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>